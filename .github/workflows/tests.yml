name: IRC Server Tests

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional valgrind
        
    - name: ğŸ”§ Setup test environment
      run: |
        make test-setup
        
    - name: ğŸ—ï¸ Compile IRC Server
      run: |
        make clean
        make
        
    - name: ğŸ§ª Run Connection Tests
      run: |
        timeout 300 ./test_connection.sh || (echo "âŒ Connection tests failed" && exit 1)
        
    - name: ğŸ“º Run Channel Tests  
      run: |
        timeout 300 ./test_channels.sh || (echo "âŒ Channel tests failed" && exit 1)
        
    - name: ğŸ’¬ Run Messaging Tests
      run: |
        timeout 300 ./test_messaging.sh || (echo "âŒ Messaging tests failed" && exit 1)
        
    - name: ğŸš€ Run Main Test Suite
      run: |
        timeout 600 ./run_tests_fixed.sh || (echo "âŒ Main test suite failed" && exit 1)

    - name: ğŸ’¾ Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: tests/
        retention-days: 7

    - name: ğŸ“Š Test Summary
      if: always()
      run: |
        echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some tests failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi

  stress-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test
    if: github.event_name == 'push' # SÃ³ roda stress tests em pushes, nÃ£o PRs

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional
        
    - name: ğŸ”§ Setup test environment
      run: make test-setup
        
    - name: ğŸ—ï¸ Compile IRC Server
      run: make
        
    - name: ğŸ”¥ Run Stress Tests
      run: |
        timeout 600 ./test_stress.sh || (echo "âš ï¸ Stress tests had issues" && exit 0)
        
    - name: ğŸ’¾ Upload stress test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stress-test-logs
        path: tests/stress_logs/
        retention-days: 3

  memory-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    if: github.event_name == 'push' && contains(github.event.head_commit.message, '[memory-test]')

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional valgrind
        
    - name: ğŸ”§ Setup test environment
      run: make test-setup
        
    - name: ğŸ—ï¸ Compile IRC Server
      run: make
        
    - name: ğŸ§  Run Memory Tests (Valgrind)
      run: |
        timeout 1200 ./test_valgrind.sh || (echo "âš ï¸ Memory tests completed with warnings" && exit 0)
        
    - name: ğŸ’¾ Upload memory test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: memory-test-logs
        path: tests/valgrind_logs/
        retention-days: 7