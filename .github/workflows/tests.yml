name: IRC Server Tests

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: 🔄 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional valgrind
        
    - name: 🔧 Setup test environment
      run: |
        make test-setup
        
    - name: 🏗️ Compile IRC Server
      run: |
        make clean
        make
        
    - name: 🧪 Run Connection Tests
      run: |
        timeout 300 ./test_connection.sh || (echo "❌ Connection tests failed" && exit 1)
        
    - name: 📺 Run Channel Tests  
      run: |
        timeout 300 ./test_channels.sh || (echo "❌ Channel tests failed" && exit 1)
        
    - name: 💬 Run Messaging Tests
      run: |
        timeout 300 ./test_messaging.sh || (echo "❌ Messaging tests failed" && exit 1)
        
    - name: 🚀 Run Main Test Suite
      run: |
        timeout 600 ./run_tests_fixed.sh || (echo "❌ Main test suite failed" && exit 1)

    - name: 💾 Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: tests/
        retention-days: 7

    - name: 📊 Test Summary
      if: always()
      run: |
        echo "## 🧪 Test Results" >> $GITHUB_STEP_SUMMARY
        if [ $? -eq 0 ]; then
          echo "✅ All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some tests failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi

  stress-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test
    if: github.event_name == 'push' # Só roda stress tests em pushes, não PRs

    steps:
    - name: 🔄 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional
        
    - name: 🔧 Setup test environment
      run: make test-setup
        
    - name: 🏗️ Compile IRC Server
      run: make
        
    - name: 🔥 Run Stress Tests
      run: |
        timeout 600 ./test_stress.sh || (echo "⚠️ Stress tests had issues" && exit 0)
        
    - name: 💾 Upload stress test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stress-test-logs
        path: tests/stress_logs/
        retention-days: 3

  memory-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test
    if: github.event_name == 'push' && contains(github.event.head_commit.message, '[memory-test]')

    steps:
    - name: 🔄 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential netcat-traditional valgrind
        
    - name: 🔧 Setup test environment
      run: make test-setup
        
    - name: 🏗️ Compile IRC Server
      run: make
        
    - name: 🧠 Run Memory Tests (Valgrind)
      run: |
        timeout 1200 ./test_valgrind.sh || (echo "⚠️ Memory tests completed with warnings" && exit 0)
        
    - name: 💾 Upload memory test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: memory-test-logs
        path: tests/valgrind_logs/
        retention-days: 7